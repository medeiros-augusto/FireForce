<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localização dos Traumas</title>
    <link rel="shortcut icon" href="logo_noar.png" type="image/x-icon">
    <link rel="stylesheet" href="public/assets/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="../public/scripts/corpo.js">
</head>


        <div class="card mb-2 text-light">
            <div class="card-header">
                <div class="text-center">
                    <h2 class="card-title mb-0">Localização dos Traumas</h2>
                </div>
            </div>
            <div class="card-body">
                <form id="TraumaLocForm">
                    <label for="traumaType" class="mt-1 mb-2">Selecione o tipo de trauma:</label>
                    <select id="traumaType" class="form-control mb-3">
                        <option value="Fratura_Luxacao_Entorse">Fraturas/Luxações/Entorses</option>
                        <option value="Ferimentos_diversos">Ferimentos diversos</option>
                        <option value="Hemorragia">Hemorragia</option>
                        <option value="Evisceracao">Evisceração</option>
                        <option value="FAB_FAF">FAB/FAF</option>
                        <option value="Amputacao">Amputação</option>
                        <option value="Queimadura_1">Queimadura 1° grau</option>
                        <option value="Queimadura_2">Queimadura 2° grau</option>
                        <option value="Queimadura_3">Queimadura 3° grau</option>
                    </select>

                    <div class="row position-relative" id="imageContainer">
                        <img id="humanBody" src="../public/images/corpo-frontal.png" alt="body-image">
                    </div>
                    <div class="d-flex justify-content-center mt-4">
                        <button type="button" class="btn btn-light fw-bold" id="undoBtn">Eliminar</button>
                    </div>
                    <div class="container mt-3">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="table-responsive table-container">
                                    <table class="table text-center text-break w-100">
                                        <tbody>
                                            <tr>
                                                <th scope="row"><img src="../public/images/Amputacao.png" alt="Amputação"
                                                        class="img-small"></th>
                                                <td class="small">Amputação</td>
                                            </tr>
                                            <tr>
                                                <th scope="row"><img src="../public/images/Evisceracao.png" alt="Amputação"
                                                        class="img-small"></th>
                                                <td class="small">Evisceração</td>
                                            </tr>
                                            <tr>
                                                <th scope="row"><img src="../public/images/FAB_FAF.png" alt="Amputação"
                                                        class="img-small"></th>
                                                <td class="small">FAB/FAF</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="table-responsive table-container">
                                    <table class="table text-center text-break w-100">
                                        <tbody>
                                            <tr>
                                                <th scope="row"><img src="../public/images/Ferimentos_diversos.png"
                                                        alt="Amputação" class="img-small"></th>
                                                <td class="small">Ferimentos diversos</td>
                                            </tr>
                                            <tr>
                                                <th scope="row"><img src="../public/images/Fratura_Luxacao_Entorse.png"
                                                        alt="Amputação" class="img-small"></th>
                                                <td class="small">Fratura/Luxação/Entorse</td>
                                            </tr>
                                            <tr>
                                                <th scope="row"><img src="../public/images/Hemorragia.png" alt="Amputação"
                                                        class="img-small"></th>
                                                <td class="small">Hemorragia</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="table-responsive table-container">
                                    <table class="table text-center text-break w-100">
                                        <tbody>
                                            <tr>
                                                <th scope="row"><img src="../public/images/Queimadura_1.png" alt="Amputação"
                                                        class="img-small"></th>
                                                <td class="small">Queimadura 1° grau</td>
                                            </tr>
                                            <tr>
                                                <th scope="row"><img src="../public/images/Queimadura_2.png" alt="Amputação"
                                                        class="img-small"></th>
                                                <td class="small">Queimadura 2° grau</td>
                                            </tr>
                                            <tr>
                                                <th scope="row"><img src="../public/images/Queimadura_3.png" alt="Amputação"
                                                        class="img-small"></th>
                                                <td class="small">Queimadura 3° grau</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-4">
                        <button type="submit" class="btn btn-light" id="backBtn">Voltar</button>
                        <button type="submit" class="btn btn-primary" id="nextBtn">Próximo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
    <script>
        function storeTraumaIcon(x, y, traumaType) {
            let traumaIcons = JSON.parse(localStorage.getItem('traumaIcons')) || [];
            traumaIcons.push({ x, y, traumaType });
            localStorage.setItem('traumaIcons', JSON.stringify(traumaIcons));
        }

        function removeLastTraumaIcon() {
            let traumaIcons = JSON.parse(localStorage.getItem('traumaIcons')) || [];
            if (traumaIcons.length > 0) {
                traumaIcons.pop();
                localStorage.setItem('traumaIcons', JSON.stringify(traumaIcons));

                let imageContainer = document.getElementById('imageContainer');
                let lastIcon = imageContainer.lastElementChild;
                if (lastIcon.tagName === 'IMG') {
                    imageContainer.removeChild(lastIcon);
                }
            }
        }

        function recreateTraumaImage() {
            let traumaIcons = JSON.parse(localStorage.getItem('traumaIcons')) || {};
            traumaIcons.forEach(icon => {
                createTraumaIcon(icon.x, icon.y, icon.traumaType);
            });
        }

        function createTraumaIcon(x, y, traumaType) {
            let icon = document.createElement('img');
            icon.src = `/trauma_icon/${traumaType}.png`;
            icon.style.position = 'absolute';
            let iconWidth = 50;
            let iconHeight = 50;
            icon.style.left = `${x - iconWidth / 2}px`;
            icon.style.top = `${y - iconHeight / 2}px`;
            icon.style.width = `${iconWidth}px`;
            icon.style.height = `${iconHeight}px`;
            icon.style.padding = '0';
            document.getElementById('imageContainer').appendChild(icon);
        }

        document.addEventListener('DOMContentLoaded', recreateTraumaImage);

        document.getElementById('undoBtn').addEventListener('click', function () {
            removeLastTraumaIcon();
        });

        document.getElementById('nextBtn').addEventListener('click', async function (e) {
            e.preventDefault();

            let canvas = await html2canvas(document.getElementById('imageContainer'));
            let imgData = canvas.toDataURL('image/png');

            let formData = JSON.parse(localStorage.getItem('formData')) || {};

            formData['traumaImage'] = imgData;

            localStorage.setItem('formData', JSON.stringify(formData));

            console.log('Stored Data:', formData);  

            window.location.href = 'traumaDesc.html';
        });

        let img = document.getElementById('humanBody');
        img.addEventListener('click', function (e) {
            let x = e.offsetX;
            let y = e.offsetY;
            let traumaType = document.getElementById('traumaType').value;

            storeTraumaIcon(x, y, traumaType);
            createTraumaIcon(x, y, traumaType);
        });

        function imageLogin() {
            fetch('/home').then(res => res.json()).then(data => {
                if (data.loggedin) {
                    window.location.href = '/home.html';
                } else {
                    window.location.href = '/login.html';
                }
            }).catch(err => {
                console.error(err);
                alert('Erro de conexão!');
            });
        }

        const activeLink = document.querySelector('.list-group-item.active');

        if (activeLink) {
            activeLink.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        }

    </script>
</body>

</html>